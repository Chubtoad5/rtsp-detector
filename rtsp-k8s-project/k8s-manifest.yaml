# This manifest contains all resources for the main application.
# It uses a single pod with two containers (web-app, camera-manager)
# that communicate via a shared in-memory volume.

# --- 1. Secret ---
# Holds all confidential data
apiVersion: v1
kind: Secret
metadata:
  name: rtsp-config
type: Opaque
stringData:
  # --- Azure Credentials ---
  AZURE_VISION_SUBSCRIPTION_KEY: "YOUR_AZURE_KEY_HERE"
  AZURE_VISION_ENDPOINT: "https://your-endpoint.cognitiveservices.azure.com/"
  
  # --- Camera Configuration ---
  CAMERA_SOURCE: "rtsp"
  RTSP_STREAM_URL: "rtsp://your-stream-url-here"
  
  # --- InfluxDB Connection Details (MUST MATCH k8s-influxdb.yaml) ---
  INFLUXDB_URL: "http://influxdb-service:8086"
  INFLUXDB_TOKEN: "YOUR_INFLUXDB_TOKEN" # !!! REPLACE THIS WITH THE SAME TOKEN !!!
  INFLUXDB_ORG: "rtsp-project-org"
  INFLUXDB_BUCKET: "analysis_data"

---
# --- 2. Deployment ---
# Deploys the application pod
apiVersion: apps/v1
kind: Deployment
metadata:
  name: rtsp-object-detector
spec:
  replicas: 1
  selector:
    matchLabels:
      app: rtsp-object-detector
  template:
    metadata:
      labels:
        app: rtsp-object-detector
    spec:
      volumes:
        # 1. Shared memory volume for IPC between containers
        - name: shared-frame-memory
          emptyDir:
            medium: Memory # Use RAM for high-speed IPC
            sizeLimit: 128Mi
      
      containers:
        # --- Container 1: The Python/Flask Web App ---
        - name: web-app
          # !!! REPLACE THIS with your new versioned image !!!
          image: "your-registry/rtsp-object-detector:v1"
          imagePullPolicy: Always # Ensures the new image is pulled
          ports:
            - containerPort: 8000
          
          # Command to run Gunicorn
          command: ["gunicorn"]
          args: [
            "--workers", "3",
            "--worker-class", "gevent",
            "--bind", "0.0.0.0:8000",
            "--log-level", "info",
            "app:app"
          ]
          
          envFrom:
            - secretRef:
                name: rtsp-config # Mounts all secrets as env variables
          
          volumeMounts:
            - name: shared-frame-memory
              mountPath: /dev/shm

        # --- Container 2: The OpenCV Camera Manager ---
        - name: camera-manager
          # !!! REPLACE THIS with your new versioned image !!!
          image: "your-registry/rtsp-object-detector:v1"
          imagePullPolicy: Always # Ensures the new image is pulled
          
          # Command to run the camera manager script
          command: ["python3"]
          args: ["camera_manager.py"]
          
          envFrom:
            - secretRef:
                name: rtsp-config # Mounts all secrets as env variables
          
          volumeMounts:
            - name: shared-frame-memory
              mountPath: /dev/shm

---
# --- 3. Service ---
# Exposes the web-app container inside the cluster
apiVersion: v1
kind: Service
metadata:
  name: rtsp-detector-service
spec:
  selector:
    app: rtsp-object-detector
  ports:
    - protocol: TCP
      port: 80
      targetPort: 8000

---
# --- 4. Ingress ---
# Exposes the service to the internet via your Nginx Ingress Controller
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: rtsp-detector-ingress
spec:
  rules:
    # !!! REPLACE THIS with your public domain !!!
    - host: "rtsp-detector.your-domain.com"
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: rtsp-detector-service
                port:
                  number: 80
